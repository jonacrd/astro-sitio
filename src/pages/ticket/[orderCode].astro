---
import Layout from "../../layouts/Base.astro";
import Navigation from "../../components/Navigation.astro";
import { prisma } from "../../lib/db";

export async function getStaticPaths() {
  return [];
}

const { orderCode } = Astro.params;

if (!orderCode) {
  return Astro.redirect('/404');
}

// Buscar la orden por c√≥digo
const order = await prisma.order.findUnique({
  where: { orderCode },
  include: {
    items: {
      include: {
        product: true
      }
    }
  }
});

if (!order) {
  return Astro.redirect('/404');
}

function formatPrice(cents: number): string {
  return new Intl.NumberFormat('es-CL', {
    style: 'currency',
    currency: 'CLP',
    minimumFractionDigits: 0
  }).format(cents);
}

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('es-CL', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  }).format(date);
}
---

<Layout title={`Ticket ${orderCode} - Tienda Web`} description="Ticket de compra">
  <Navigation />
  
  <div class="ticket-container">
    <div class="ticket">
      <header class="ticket-header">
        <h1>üé´ Ticket de Compra</h1>
        <div class="order-info">
          <p><strong>C√≥digo:</strong> {orderCode}</p>
          <p><strong>Fecha:</strong> {formatDate(order.createdAt)}</p>
        </div>
      </header>

      <div class="ticket-content">
        <h2>üì¶ Productos Comprados</h2>
        
        <div class="items-list">
          {order.items.map(item => (
            <div class="item-row">
              <div class="item-info">
                <h3>{item.product.name}</h3>
                <p class="item-description">{item.product.description}</p>
              </div>
              <div class="item-details">
                <span class="quantity">Cantidad: {item.qty}</span>
                <span class="price">{formatPrice(item.priceCents)}</span>
                <span class="subtotal">{formatPrice(item.qty * item.priceCents)}</span>
              </div>
            </div>
          ))}
        </div>

        <div class="ticket-total">
          <div class="total-row">
            <span>Total:</span>
            <span class="total-amount">{formatPrice(order.totalCents)}</span>
          </div>
        </div>
      </div>

      <footer class="ticket-footer">
        <p>¬°Gracias por tu compra! üéâ</p>
        <p>Guarda este ticket como comprobante</p>
        <div class="ticket-actions">
          <button onclick="window.print()" class="print-btn">üñ®Ô∏è Imprimir</button>
          <a href="/" class="continue-btn">üõçÔ∏è Seguir Comprando</a>
        </div>
      </footer>
    </div>
  </div>
</Layout>

<style>
  .ticket-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 2rem 1rem;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }

  .ticket {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    max-width: 600px;
    width: 100%;
    overflow: hidden;
  }

  .ticket-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    text-align: center;
  }

  .ticket-header h1 {
    margin: 0 0 1rem 0;
    font-size: 2rem;
    font-weight: 700;
  }

  .order-info {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .order-info p {
    margin: 0;
    font-size: 1rem;
    opacity: 0.9;
  }

  .ticket-content {
    padding: 2rem;
  }

  .ticket-content h2 {
    color: #333;
    margin: 0 0 1.5rem 0;
    font-size: 1.5rem;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 0.5rem;
  }

  .items-list {
    margin-bottom: 2rem;
  }

  .item-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1rem 0;
    border-bottom: 1px solid #f0f0f0;
    gap: 1rem;
  }

  .item-row:last-child {
    border-bottom: none;
  }

  .item-info {
    flex: 1;
  }

  .item-info h3 {
    margin: 0 0 0.5rem 0;
    color: #333;
    font-size: 1.1rem;
  }

  .item-description {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
    line-height: 1.4;
  }

  .item-details {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.25rem;
    min-width: 120px;
  }

  .quantity {
    font-size: 0.9rem;
    color: #666;
  }

  .price {
    font-size: 0.9rem;
    color: #666;
  }

  .subtotal {
    font-weight: 600;
    color: #2e7d32;
    font-size: 1rem;
  }

  .ticket-total {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.2rem;
    font-weight: 700;
  }

  .total-amount {
    color: #2e7d32;
    font-size: 1.5rem;
  }

  .ticket-footer {
    background: #f8f9fa;
    padding: 2rem;
    text-align: center;
    border-top: 1px solid #e0e0e0;
  }

  .ticket-footer p {
    margin: 0 0 1rem 0;
    color: #666;
  }

  .ticket-footer p:first-child {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
  }

  .ticket-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .print-btn, .continue-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .print-btn {
    background: #6c757d;
    color: white;
  }

  .print-btn:hover {
    background: #5a6268;
    transform: translateY(-2px);
  }

  .continue-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .continue-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .ticket-container {
      padding: 1rem;
    }

    .ticket-header {
      padding: 1.5rem;
    }

    .ticket-header h1 {
      font-size: 1.5rem;
    }

    .order-info {
      flex-direction: column;
      text-align: center;
    }

    .ticket-content {
      padding: 1.5rem;
    }

    .item-row {
      flex-direction: column;
      gap: 0.5rem;
    }

    .item-details {
      align-items: flex-start;
      flex-direction: row;
      gap: 1rem;
    }

    .ticket-footer {
      padding: 1.5rem;
    }

    .ticket-actions {
      flex-direction: column;
    }

    .print-btn, .continue-btn {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .ticket-header h1 {
      font-size: 1.3rem;
    }

    .ticket-content h2 {
      font-size: 1.3rem;
    }

    .total-amount {
      font-size: 1.3rem;
    }
  }

  /* Print styles */
  @media print {
    .ticket-container {
      background: white;
      padding: 0;
    }

    .ticket {
      box-shadow: none;
      border: 1px solid #ccc;
    }

    .ticket-actions {
      display: none;
    }
  }
</style>
