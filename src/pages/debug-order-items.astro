---
import BaseLayout from '../layouts/BaseLayout.astro'
---

<BaseLayout title="Debug Order Items">
  <main class="min-h-screen bg-gray-900 text-white p-8">
    <div class="max-w-6xl mx-auto">
      <h1 class="text-2xl font-bold text-red-400 mb-6">üîç Debug Order Items & Products</h1>
      
      <div class="bg-gray-800 rounded-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-blue-400 mb-4">üìã Verificar Estructura de Datos</h2>
        <div id="order-items-status" class="space-y-4">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
          <p class="text-center text-gray-400">Cargando informaci√≥n...</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-gray-800 rounded-lg p-6">
          <h2 class="text-xl font-bold text-green-400 mb-4">üì¶ Order Items</h2>
          <div id="order-items-list" class="space-y-2">
            <p class="text-gray-400">Cargando...</p>
          </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-6">
          <h2 class="text-xl font-bold text-yellow-400 mb-4">üõçÔ∏è Products</h2>
          <div id="products-list" class="space-y-2">
            <p class="text-gray-400">Cargando...</p>
          </div>
        </div>
      </div>

      <div class="bg-gray-800 rounded-lg p-6 mt-6">
        <h2 class="text-xl font-bold text-purple-400 mb-4">üîó JOIN Test</h2>
        <div id="join-test" class="space-y-2">
          <p class="text-gray-400">Cargando...</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    async function checkOrderItems() {
      try {
        const response = await fetch('/api/debug/check-order-items');
        const result = await response.json();
        
        if (result.success) {
          const { orderItems, products, joinedData, joinError } = result.data;
          
          // Mostrar order items
          const orderItemsDiv = document.getElementById('order-items-list');
          if (orderItems && orderItems.length > 0) {
            orderItemsDiv.innerHTML = orderItems.map(item => `
              <div class="bg-gray-700 p-3 rounded">
                <p class="text-white text-sm"><strong>ID:</strong> ${item.id}</p>
                <p class="text-gray-300 text-sm"><strong>Order ID:</strong> ${item.order_id}</p>
                <p class="text-gray-300 text-sm"><strong>Product ID:</strong> ${item.product_id || 'N/A'}</p>
                <p class="text-gray-300 text-sm"><strong>Title:</strong> ${item.title || 'N/A'}</p>
                <p class="text-gray-300 text-sm"><strong>Price:</strong> $${((item.price_cents || 0) / 100).toFixed(2)}</p>
                <p class="text-gray-300 text-sm"><strong>Qty:</strong> ${item.qty || 1}</p>
              </div>
            `).join('');
          } else {
            orderItemsDiv.innerHTML = '<p class="text-red-400">No hay order items</p>';
          }
          
          // Mostrar products
          const productsDiv = document.getElementById('products-list');
          if (products && products.length > 0) {
            productsDiv.innerHTML = products.map(product => `
              <div class="bg-gray-700 p-3 rounded">
                <p class="text-white text-sm"><strong>ID:</strong> ${product.id}</p>
                <p class="text-gray-300 text-sm"><strong>Title:</strong> ${product.title}</p>
                <p class="text-gray-300 text-sm"><strong>Price:</strong> $${((product.price_cents || 0) / 100).toFixed(2)}</p>
              </div>
            `).join('');
          } else {
            productsDiv.innerHTML = '<p class="text-red-400">No hay products</p>';
          }
          
          // Mostrar JOIN test
          const joinTestDiv = document.getElementById('join-test');
          if (joinError) {
            joinTestDiv.innerHTML = `
              <div class="bg-red-900/20 border border-red-600/30 p-3 rounded-lg">
                <h3 class="font-semibold text-red-400">‚ùå Error en JOIN</h3>
                <p class="text-red-200 text-sm">${joinError}</p>
              </div>
            `;
          } else if (joinedData && joinedData.length > 0) {
            joinTestDiv.innerHTML = joinedData.map(item => `
              <div class="bg-gray-700 p-3 rounded">
                <p class="text-white text-sm"><strong>Order Item ID:</strong> ${item.id}</p>
                <p class="text-gray-300 text-sm"><strong>Product Title:</strong> ${item.product?.title || 'No product data'}</p>
                <p class="text-gray-300 text-sm"><strong>Product Price:</strong> $${((item.product?.price_cents || 0) / 100).toFixed(2)}</p>
                <p class="text-gray-300 text-sm"><strong>Item Price:</strong> $${((item.price_cents || 0) / 100).toFixed(2)}</p>
                <p class="text-gray-300 text-sm"><strong>Qty:</strong> ${item.qty || 1}</p>
              </div>
            `).join('');
          } else {
            joinTestDiv.innerHTML = '<p class="text-yellow-400">No hay datos de JOIN</p>';
          }
          
        } else {
          document.getElementById('order-items-status').innerHTML = `
            <div class="bg-red-900/20 border border-red-600/30 p-3 rounded-lg">
              <h3 class="font-semibold text-red-400">‚ùå Error</h3>
              <p class="text-red-200 text-sm">${result.error}</p>
            </div>
          `;
        }
      } catch (error) {
        document.getElementById('order-items-status').innerHTML = `
          <div class="bg-red-900/20 border border-red-600/30 p-3 rounded-lg">
            <h3 class="font-semibold text-red-400">‚ùå Error de conexi√≥n</h3>
            <p class="text-red-200 text-sm">${error.message}</p>
          </div>
        `;
      }
    }

    // Cargar informaci√≥n al inicio
    checkOrderItems();
  </script>
</BaseLayout>
