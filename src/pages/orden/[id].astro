---
export const prerender = false;

import Layout from "../../layouts/Base.astro";
import Navigation from "../../components/Navigation.astro";
import { prisma } from "../../lib/db";

const id = Number(Astro.params.id || 0);
const order = id
  ? await prisma.order.findUnique({
      where: { id },
      include: {
        items: { include: { variant: { include: { product: true } } } }
      }
    })
  : null;

const formatPrice = (cents: number) => {
  return (cents / 100).toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
};

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('es-CL', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  }).format(new Date(date));
};

const getStatusText = (status: string) => {
  const statusMap: Record<string, string> = {
    'PENDING': 'Pendiente',
    'PAID': 'Pagado',
    'CANCELLED': 'Cancelado',
    'FULFILLED': 'Completado'
  };
  return statusMap[status] || status;
};

const getStatusColor = (status: string) => {
  const colorMap: Record<string, string> = {
    'PENDING': '#ffc107',
    'PAID': '#28a745',
    'CANCELLED': '#dc3545',
    'FULFILLED': '#007bff'
  };
  return colorMap[status] || '#6c757d';
};
---

<Layout title={`Orden #${id} - Tienda Web`} description="Resumen de tu compra">
  <Navigation />
  
  <div class="container">
    <main class="order-page">
    {order ? (
        <div class="order-ticket">
          <!-- Header del ticket -->
          <div class="ticket-header">
            <div class="company-info">
              <h1>üõçÔ∏è Tienda Web</h1>
              <p>Tu tienda de confianza</p>
            </div>
            <div class="order-info">
              <div class="order-number">Orden #${order.id}</div>
              <div class="order-date">{formatDate(order.createdAt)}</div>
            </div>
          </div>

          <!-- Estado de la orden -->
          <div class="order-status">
            <div class="status-badge" style={`background-color: ${getStatusColor(order.status)}`}>
              {getStatusText(order.status)}
            </div>
            <div class="status-message">
              {order.status === 'PENDING' && 'Tu orden est√° siendo procesada'}
              {order.status === 'PAID' && '¬°Pago confirmado! Preparando tu pedido'}
              {order.status === 'FULFILLED' && '¬°Tu pedido ha sido completado!'}
              {order.status === 'CANCELLED' && 'Esta orden ha sido cancelada'}
            </div>
          </div>

          <!-- Informaci√≥n del cliente -->
          <div class="customer-info">
            <h3>üìã Informaci√≥n del Pedido</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">N√∫mero de Orden:</span>
                <span class="info-value">#{order.id}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Fecha:</span>
                <span class="info-value">{formatDate(order.createdAt)}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Estado:</span>
                <span class="info-value" style={`color: ${getStatusColor(order.status)}`}>
                  {getStatusText(order.status)}
                </span>
              </div>
              <div class="info-item">
                <span class="info-label">Moneda:</span>
                <span class="info-value">{order.currency}</span>
              </div>
            </div>
          </div>

          <!-- Items de la orden -->
          <div class="order-items">
            <h3>üõí Productos</h3>
            <div class="items-list">
              {order.items.map((item, index) => (
                <div class="order-item" key={index}>
                  <div class="item-image">
                    <img 
                      src={item.variant?.product?.imageUrl || "/img/placeholder.png"} 
                      alt={item.variant?.product?.name || 'Producto'}
                      loading="lazy"
                    />
                  </div>
                  <div class="item-details">
                    <h4 class="item-name">{item.variant?.product?.name || 'Producto'}</h4>
                    <div class="item-specs">
                      <span class="spec">Talla: {item.size || item.variant?.size || '‚Äî'}</span>
                      <span class="spec">Color: {item.colorName || item.colorHex || '‚Äî'}</span>
                      {item.variant?.sku && <span class="spec">SKU: {item.variant.sku}</span>}
                    </div>
                    <div class="item-quantity">Cantidad: {item.quantity}</div>
                  </div>
                  <div class="item-price">
                    <div class="unit-price">{formatPrice(item.salePriceCents || item.variant?.salePriceCents || 0)}</div>
                    <div class="total-price">{formatPrice((item.salePriceCents || item.variant?.salePriceCents || 0) * item.quantity)}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <!-- Resumen de precios -->
          <div class="price-summary">
            <h3>üí∞ Resumen de Precios</h3>
            <div class="price-breakdown">
              <div class="price-line">
                <span>Subtotal:</span>
                <span>{formatPrice(order.subtotalCents)}</span>
              </div>
              {order.discountCents > 0 && (
                <div class="price-line discount">
                  <span>Descuento:</span>
                  <span>-{formatPrice(order.discountCents)}</span>
                </div>
              )}
              <div class="price-line">
                <span>Env√≠o:</span>
                <span>Gratis</span>
              </div>
              <div class="price-line total">
                <span>Total:</span>
                <span>{formatPrice(order.totalCents)}</span>
              </div>
            </div>
          </div>

          <!-- Informaci√≥n adicional -->
          <div class="order-footer">
            <div class="footer-info">
              <p>üìß Recibir√°s un email de confirmaci√≥n en breve</p>
              <p>üì± Puedes hacer seguimiento de tu pedido con este n√∫mero: <strong>#{order.id}</strong></p>
              <p>‚è∞ Tiempo estimado de entrega: 2-5 d√≠as h√°biles</p>
            </div>
            
            <div class="footer-actions">
              <button onclick="window.print()" class="btn btn-secondary">
                üñ®Ô∏è Imprimir Ticket
              </button>
              <a href="/" class="btn btn-primary">
                üè† Volver a la Tienda
              </a>
            </div>
          </div>

          <!-- C√≥digo QR simulado -->
          <div class="qr-section">
            <div class="qr-code">
              <div class="qr-placeholder">
                <div class="qr-icon">üì±</div>
                <p>C√≥digo QR</p>
                <small>#{order.id}</small>
              </div>
            </div>
            <p class="qr-text">Escanea este c√≥digo para acceder a los detalles de tu orden</p>
          </div>
        </div>
      ) : (
        <div class="error-page">
          <div class="error-icon">‚ùå</div>
          <h2>Orden no encontrada</h2>
          <p>La orden que buscas no existe o ha sido eliminada.</p>
          <a href="/" class="btn btn-primary">Volver a la Tienda</a>
        </div>
    )}
  </main>
  </div>

  <style>
    .order-page {
      padding: 2rem 0;
      max-width: 800px;
      margin: 0 auto;
    }

    .order-ticket {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .ticket-header {
      background: linear-gradient(135deg, #8b7355 0%, #a8a47a 100%);
      color: white;
      padding: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .company-info h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: bold;
    }

    .company-info p {
      margin: 0.5rem 0 0 0;
      opacity: 0.9;
    }

    .order-info {
      text-align: right;
    }

    .order-number {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .order-date {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    .order-status {
      padding: 1.5rem 2rem;
      background: #f5f2e8;
      border-bottom: 1px solid #8b7355;
      text-align: center;
    }

    .status-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      color: white;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .status-message {
      color: #666;
      font-size: 0.9rem;
    }

    .customer-info, .order-items, .price-summary {
      padding: 2rem;
      border-bottom: 1px solid #8b7355;
    }

    .customer-info h3, .order-items h3, .price-summary h3 {
      margin: 0 0 1.5rem 0;
      color: #333;
      font-size: 1.3rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .info-label {
      font-weight: 500;
      color: #666;
    }

    .info-value {
      font-weight: bold;
      color: #333;
    }

    .items-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .order-item {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      border: 1px solid #8b7355;
      border-radius: 10px;
      background: #f5f2e8;
    }

    .item-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .item-details {
      flex: 1;
    }

    .item-name {
      margin: 0 0 0.5rem 0;
      color: #333;
      font-size: 1.1rem;
    }

    .item-specs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .spec {
      background: white;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      color: #666;
    }

    .item-quantity {
      color: #666;
      font-size: 0.9rem;
    }

    .item-price {
      text-align: right;
      flex-shrink: 0;
    }

    .unit-price {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
    }

    .total-price {
      font-weight: bold;
      color: #8b7355;
      font-size: 1.1rem;
    }

    .price-breakdown {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .price-line {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
    }

    .price-line.discount {
      color: #28a745;
    }

    .price-line.total {
      border-top: 2px solid #8b7355;
      font-weight: bold;
      font-size: 1.2rem;
      color: #333;
      margin-top: 0.5rem;
      padding-top: 1rem;
    }

    .order-footer {
      padding: 2rem;
      background: #f5f2e8;
      text-align: center;
    }

    .footer-info {
      margin-bottom: 2rem;
    }

    .footer-info p {
      margin: 0.5rem 0;
      color: #666;
    }

    .footer-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      display: inline-block;
    }

    .btn-primary {
      background: #8b7355;
      color: white;
    }

    .btn-primary:hover {
      background: #6b5a42;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: white;
      color: #8b7355;
      border: 2px solid #8b7355;
    }

    .btn-secondary:hover {
      background: #8b7355;
      color: white;
    }

    .qr-section {
      padding: 2rem;
      text-align: center;
      background: #f5f2e8;
    }

    .qr-code {
      display: inline-block;
      margin-bottom: 1rem;
    }

    .qr-placeholder {
      width: 120px;
      height: 120px;
      border: 2px dashed #ccc;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: white;
    }

    .qr-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .qr-text {
      color: #666;
      font-size: 0.9rem;
    }

    .error-page {
      text-align: center;
      padding: 4rem 2rem;
    }

    .error-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .error-page h2 {
      color: #333;
      margin-bottom: 1rem;
    }

    .error-page p {
      color: #666;
      margin-bottom: 2rem;
    }

    /* RESPONSIVE ORDEN */
    @media (max-width: 1200px) {
      .order-page {
        padding: 1.5rem 0;
      }
      
      .order-ticket {
        margin: 0 1rem;
      }
      
      .info-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .order-page {
        padding: 1rem 0;
      }
      
      .order-ticket {
        margin: 0 0.5rem;
        border-radius: 15px;
      }
      
      .ticket-header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
        padding: 1.5rem;
      }

      .company-info h1 {
        font-size: 1.8rem;
      }

      .order-info {
        text-align: center;
      }

      .order-number {
        font-size: 1.3rem;
      }

      .order-status {
        padding: 1rem 1.5rem;
      }

      .customer-info, .order-items, .price-summary {
        padding: 1.5rem;
      }

      .customer-info h3, .order-items h3, .price-summary h3 {
        font-size: 1.2rem;
        margin-bottom: 1rem;
      }

      .info-grid {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }

      .order-item {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
        padding: 1rem;
      }

      .item-image {
        width: 100px;
        height: 100px;
        margin: 0 auto;
      }

      .item-details {
        text-align: center;
      }

      .item-name {
        font-size: 1rem;
      }

      .item-specs {
        justify-content: center;
      }

      .item-price {
        text-align: center;
      }

      .price-breakdown {
        gap: 0.8rem;
      }

      .price-line.total {
        font-size: 1.1rem;
      }

      .order-footer {
        padding: 1.5rem;
      }

      .footer-info p {
        font-size: 0.9rem;
      }

      .footer-actions {
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      .btn {
        width: 100%;
        max-width: 250px;
        padding: 0.8rem 1.5rem;
        font-size: 0.9rem;
      }

      .qr-section {
        padding: 1.5rem;
      }

      .qr-placeholder {
        width: 100px;
        height: 100px;
      }

      .qr-icon {
        font-size: 1.5rem;
      }
    }

    @media (max-width: 480px) {
      .order-ticket {
        margin: 0 0.25rem;
        border-radius: 10px;
      }
      
      .ticket-header {
        padding: 1rem;
      }

      .company-info h1 {
        font-size: 1.6rem;
      }

      .order-number {
        font-size: 1.2rem;
      }

      .order-status {
        padding: 0.8rem 1rem;
      }

      .customer-info, .order-items, .price-summary {
        padding: 1rem;
      }

      .customer-info h3, .order-items h3, .price-summary h3 {
        font-size: 1.1rem;
      }

      .order-item {
        padding: 0.8rem;
      }

      .item-image {
        width: 80px;
        height: 80px;
      }

      .item-name {
        font-size: 0.9rem;
      }

      .item-specs {
        flex-direction: column;
        gap: 0.3rem;
      }

      .spec {
        font-size: 0.7rem;
      }

      .order-footer {
        padding: 1rem;
      }

      .footer-info p {
        font-size: 0.8rem;
      }

      .btn {
        padding: 0.7rem 1rem;
        font-size: 0.8rem;
      }

      .qr-section {
        padding: 1rem;
      }

      .qr-placeholder {
        width: 80px;
        height: 80px;
      }

      .qr-icon {
        font-size: 1.2rem;
      }

      .qr-text {
        font-size: 0.8rem;
      }
    }

    @media print {
      .order-page {
        padding: 0;
      }

      .order-ticket {
        box-shadow: none;
        border-radius: 0;
      }

      .footer-actions {
        display: none;
      }

      .ticket-header {
        background: #333 !important;
        color: white !important;
      }
    }
  </style>
</Layout>
