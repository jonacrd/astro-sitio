---
import BaseLayout from '../layouts/BaseLayout.astro'
import SearchBarEnhanced from '../components/react/SearchBarEnhanced.tsx'
import QuickActions from '../components/react/QuickActions.tsx'
import RealGridBlocks from '../components/react/RealGridBlocks.tsx'
import RealProductFeed from '../components/react/RealProductFeed.tsx'
import QuestionModal from '../components/react/QuestionModal.tsx'
import SaleModal from '../components/react/SaleModal.tsx'
import BannerSlider from '../components/react/BannerSlider.tsx'
---

<BaseLayout 
  title="Town - Feed Social de Compras"
  description="Descubre productos locales en un feed tipo red social - Town"
>
  <link rel="stylesheet" href="/src/styles/feed-animations.css" />
  <div class="min-h-screen bg-dark-primary">




    <!-- Banner Slider -->
    <section class="px-4 py-6">
      <div class="max-w-7xl mx-auto">
        <BannerSlider 
          client:load
          images={[
            '/banners/primer_banner.png',
            '/banners/segundo_banner.png',
            '/banners/tercer_banner.png'
          ]}
          interval={5000}
        />
      </div>
    </section>

    <!-- Search Bar Mejorado -->
    <section class="px-4 pb-6">
      <div class="max-w-7xl mx-auto">
        <SearchBarEnhanced 
          client:load 
          onAddToCart={(productId, sellerId) => {
            console.log('ðŸ›’ AÃ±adir al carrito:', productId, sellerId);
            // TODO: Implementar aÃ±adir al carrito
          }}
          onViewProduct={(productId) => {
            console.log('ðŸ‘ï¸ Ver producto:', productId);
            // TODO: Implementar ver producto
          }}
          onViewSeller={(sellerId) => {
            console.log('ðŸª Ver vendedor:', sellerId);
            // TODO: Implementar ver vendedor
          }}
          placeholder="Â¿QuÃ© necesitas? Ej: cerveza, hamburguesa, corte de cabello..."
        />
      </div>
    </section>

    <!-- Acciones RÃ¡pidas -->
    <QuickActions 
      client:load 
      onAskQuestion={() => {
        document.getElementById('question-modal')?.click();
      }}
      onPublishSale={() => {
        document.getElementById('sale-modal')?.click();
      }}
    />

        <!-- Grid DinÃ¡mico de 4 Bloques - DATOS REALES -->
        <RealGridBlocks 
          client:load 
          onAddToCart={(productId) => {
            console.log('Add to cart:', productId);
            // TODO: Implementar aÃ±adir al carrito
          }}
          onViewProduct={(productId) => {
            console.log('View product:', productId);
            // TODO: Implementar ver producto
          }}
          onContactService={(serviceId) => {
            console.log('Contact service:', serviceId);
            // TODO: Implementar contacto con servicio
          }}
        />

    <!-- Feed Principal - DATOS REALES -->
    <main class="pb-20">
      <RealProductFeed 
        client:load 
        className=""
      />
    </main>

    <!-- Modales -->
    <QuestionModal 
      client:load 
      isOpen={false}
      onClose={() => {}}
      onSubmit={(question) => {
        console.log('Question submitted:', question);
        // TODO: Implementar envÃ­o de pregunta
      }}
    />

    <SaleModal 
      client:load 
      isOpen={false}
      onClose={() => {}}
      onSubmit={(sale) => {
        console.log('Sale submitted:', sale);
        // TODO: Implementar envÃ­o de venta
      }}
    />

  </div>
</BaseLayout>

<script>
  // LÃ³gica para abrir modales y manejar carrito
  document.addEventListener('DOMContentLoaded', () => {
    console.log('Feed Social de Compras cargado');
    
    // Inicializar carrito vacÃ­o si no existe
    if (!localStorage.getItem('cart')) {
      localStorage.setItem('cart', '[]');
    }
    
    // Escuchar eventos de actualizaciÃ³n del carrito
    window.addEventListener('cart-updated', (event) => {
      console.log('ðŸ›’ Carrito actualizado:', event.detail);
      
      // Actualizar contador en el header
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
      
      // Buscar y actualizar contador en el header
      const cartCountElements = document.querySelectorAll('[data-cart-count], .cart-count, .cart-badge');
      cartCountElements.forEach(element => {
        element.textContent = totalItems.toString();
        element.style.display = totalItems > 0 ? 'block' : 'none';
      });
      
      console.log(`ðŸ“Š Carrito actual: ${totalItems} items total`);
      console.log('ðŸ›’ Items en carrito:', cart);
    });
  });
</script>
