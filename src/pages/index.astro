---
import BaseLayout from '@/layouts/BaseLayout.astro'
import SmartSearch from '@/components/react/SmartSearch.tsx'
import FeedResults from '@/components/react/FeedResults.tsx'
import HowItWorks from '@/components/react/HowItWorks.tsx'
import PopularProducts from '@/components/react/PopularProducts.tsx'
import CategoryBanners from '@/components/react/CategoryBanners.tsx'
import InfiniteFeed from '@/components/react/InfiniteFeed.tsx'
---

<style>
  /* Estilos para carruseles */
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Estilos para feed 9:16 */
  .aspect-9-16 {
    aspect-ratio: 9 / 16;
  }

  /* Contenedor principal */
  .main-container {
    max-width: 1200px;
    margin: 0 auto;
  }
</style>

<BaseLayout 
  title="Town - Compra rÃ¡pido con IA"
  description="Compra rÃ¡pido, con IA y descuentos locales - Town"
>
  <div class="main-container">
    <!-- Hero Section RediseÃ±ado -->
    <section class="bg-gradient-to-br from-sky-900 via-slate-900 to-slate-900">
      <div class="container mx-auto px-4 py-10 md:py-14">
        <!-- Auth Navigation -->
        <nav class="flex justify-end gap-3 mb-8">
          <button id="btn-login" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white border border-white/20 transition-colors">
            Entrar
          </button>
          <button id="btn-register" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">
            Registrarse
          </button>
          <a id="link-vender" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white border border-white/20 transition-colors hidden">
            Vender
          </a>
          <a href="/dashboard" id="link-dashboard" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition-colors hidden">
            Dashboard
          </a>
          <button id="btn-logout" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors hidden">
            Salir
          </button>
          <button id="btn-refresh" class="px-2 py-1 rounded bg-yellow-600 text-white text-xs hover:bg-yellow-700 transition-colors">
            ðŸ”„
          </button>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
          <!-- Columna izquierda: TITULAR grande -->
          <div class="lg:col-span-5 max-w-screen-md">
            <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-white">
              Compra en tu torre
            </h1>
            <p class="mt-3 text-white/85 md:text-lg leading-relaxed">
              Encuentra productos locales, compara precios y recibe en casa
            </p>
          </div>

          <!-- Columna derecha: Barra IA -->
          <div class="lg:col-span-7">
            <h2 class="text-2xl md:text-3xl font-bold text-white">Busca productos cerca â€” con tus vendedores de siempre</h2>
            
            <!-- Barra IA -->
            <div class="mt-6">
              <SmartSearch client:load />
            </div>
          </div>
        </div>

        <!-- Resultados bajo el hero -->
        <FeedResults client:load />
      </div>
    </section>

    <!-- CÃ³mo funciona Town -->
    <HowItWorks client:load />

    <!-- Productos Populares -->
    <PopularProducts client:load />

    <!-- Banners por CategorÃ­a -->
    <CategoryBanners client:load />

    <!-- Feed Infinito -->
    <InfiniteFeed client:load />

  <!-- Modales de autenticaciÃ³n -->
  <dialog id="dlg-login" class="backdrop:bg-black/50 bg-white rounded-lg p-6 max-w-md w-full">
    <form id="form-login" class="space-y-4">
      <h3 class="text-lg font-bold">Iniciar SesiÃ³n</h3>
      <input name="phone" type="text" placeholder="TelÃ©fono o Username (ej: user1)" required class="w-full p-2 border rounded" />
      <input name="password" type="password" placeholder="ContraseÃ±a" required class="w-full p-2 border rounded" />
      <div class="flex gap-2">
        <button type="submit" class="flex-1 bg-blue-600 text-white p-2 rounded">Entrar</button>
        <button type="button" id="close-login" class="px-4 py-2 border rounded">Cancelar</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlg-register" class="backdrop:bg-black/50 bg-white rounded-lg p-6 max-w-md w-full">
    <form id="form-register" class="space-y-4">
      <h3 class="text-lg font-bold">Registrarse</h3>
      <input name="name" type="text" placeholder="Nombre completo" required class="w-full p-2 border rounded" />
      <input name="phone" type="tel" placeholder="TelÃ©fono" required class="w-full p-2 border rounded" />
      <input name="password" type="password" placeholder="ContraseÃ±a" required class="w-full p-2 border rounded" />
      <div class="flex gap-2">
        <button type="submit" class="flex-1 bg-green-600 text-white p-2 rounded">Registrarse</button>
        <button type="button" id="close-register" class="px-4 py-2 border rounded">Cancelar</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlg-vender" class="backdrop:bg-black/50 bg-white rounded-lg p-6 max-w-md w-full">
    <form id="form-vender" class="space-y-4">
      <h3 class="text-lg font-bold">Registrarse como Vendedor</h3>
      <input name="name" type="text" placeholder="Nombre completo" required class="w-full p-2 border rounded" />
      <input name="phone" type="tel" placeholder="TelÃ©fono" required class="w-full p-2 border rounded" />
      <input name="password" type="password" placeholder="ContraseÃ±a" required class="w-full p-2 border rounded" />
      <input name="storeName" type="text" placeholder="Nombre de la tienda" required class="w-full p-2 border rounded" />
      <input name="addressLine1" type="text" placeholder="DirecciÃ³n" required class="w-full p-2 border rounded" />
      <input name="comuna" type="text" placeholder="Comuna" required class="w-full p-2 border rounded" />
      <input name="ciudad" type="text" placeholder="Ciudad" required class="w-full p-2 border rounded" />
      <div class="flex gap-2">
        <button type="submit" class="flex-1 bg-indigo-600 text-white p-2 rounded">Registrarse</button>
        <button type="button" id="close-vender" class="px-4 py-2 border rounded">Cancelar</button>
      </div>
    </form>
  </dialog>

</BaseLayout>

<script>
  // Elementos del DOM
  const btnLogin = document.getElementById('btn-login');
  const btnRegister = document.getElementById('btn-register');
  const btnLogout = document.getElementById('btn-logout');
  const btnRefresh = document.getElementById('btn-refresh');
  const linkVender = document.getElementById('link-vender');
  const linkDash = document.getElementById('link-dashboard');
  
  const dlgLogin = document.getElementById('dlg-login') as HTMLDialogElement;
  const dlgRegister = document.getElementById('dlg-register') as HTMLDialogElement;
  const dlgVender = document.getElementById('dlg-vender') as HTMLDialogElement;
  
  const formLogin = document.getElementById('form-login') as HTMLFormElement;
  const formRegister = document.getElementById('form-register') as HTMLFormElement;
  const formVender = document.getElementById('form-vender') as HTMLFormElement;

  // FunciÃ³n para refrescar el estado de autenticaciÃ³n
  async function refreshMe() {
    try {
      const r = await fetch('/api/auth/me-universal');
      const data = r.ok ? await r.json() : { user: null };
      const user = data?.user;
      
      console.log('Auth state:', user ? `Logged in as ${user.name} (${user.role})` : 'Not logged in');
      
      if (user) {
        // Usuario logueado - mostrar logout y dashboard
        btnLogin?.classList.add('hidden');
        btnRegister?.classList.add('hidden');
        linkVender?.classList.add('hidden');
        btnLogout?.classList.remove('hidden');
        linkDash?.classList.remove('hidden');
      } else {
        // Usuario no logueado - mostrar login y registro
        btnLogin?.classList.remove('hidden');
        btnRegister?.classList.remove('hidden');
        linkVender?.classList.remove('hidden');
        btnLogout?.classList.add('hidden');
        linkDash?.classList.add('hidden');
      }
    } catch (error) {
      console.error('Error checking auth:', error);
      // En caso de error, asumir que no hay usuario logueado
      btnLogin?.classList.remove('hidden');
      btnRegister?.classList.remove('hidden');
      linkVender?.classList.remove('hidden');
      btnLogout?.classList.add('hidden');
      linkDash?.classList.add('hidden');
    }
  }

  // Event listeners para botones
  btnLogin?.addEventListener('click', () => dlgLogin?.showModal());
  btnRegister?.addEventListener('click', () => dlgRegister?.showModal());
  btnRefresh?.addEventListener('click', () => {
    console.log('Manual refresh clicked');
    refreshMe();
  });
  linkVender?.addEventListener('click', () => dlgVender?.showModal());

  // Cerrar modales
  document.getElementById('close-login')?.addEventListener('click', () => dlgLogin?.close());
  document.getElementById('close-register')?.addEventListener('click', () => dlgRegister?.close());
  document.getElementById('close-vender')?.addEventListener('click', () => dlgVender?.close());

  // Cerrar modales al hacer clic fuera
  dlgLogin?.addEventListener('click', (e) => {
    if (e.target === dlgLogin) dlgLogin.close();
  });
  dlgRegister?.addEventListener('click', (e) => {
    if (e.target === dlgRegister) dlgRegister.close();
  });
  dlgVender?.addEventListener('click', (e) => {
    if (e.target === dlgVender) dlgVender.close();
  });

  // Formulario de login
  formLogin?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const body = Object.fromEntries(new FormData(e.target as HTMLFormElement).entries());
    
    try {
      const r = await fetch('/api/auth/login-universal', { 
        method: 'POST', 
        headers: { 'content-type': 'application/json' }, 
        body: JSON.stringify(body) 
      });
      
      if (r.ok) { 
        dlgLogin?.close(); 
        refreshMe(); 
      } else { 
        alert('Credenciales incorrectas'); 
      }
    } catch (error) {
      alert('Error al iniciar sesiÃ³n');
    }
  });

  // Formulario de registro
  formRegister?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const body = Object.fromEntries(new FormData(e.target as HTMLFormElement).entries());
    
    try {
      const r = await fetch('/api/auth/register-universal', { 
        method: 'POST', 
        headers: { 'content-type': 'application/json' }, 
        body: JSON.stringify(body) 
      });
      
      if (r.ok) { 
        dlgRegister?.close(); 
        refreshMe(); 
      } else { 
        alert('No se pudo registrar. El telÃ©fono ya estÃ¡ en uso.'); 
      }
    } catch (error) {
      alert('Error al registrarse');
    }
  });

  // Formulario de vendedor
  formVender?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const body = Object.fromEntries(new FormData(e.target as HTMLFormElement).entries());
    
    try {
      const r = await fetch('/api/seller/profile', { 
        method: 'POST', 
        headers: { 'content-type': 'application/json' }, 
        body: JSON.stringify(body) 
      });
      
      if (r.ok) { 
        dlgVender?.close(); 
        location.href = '/dashboard';
      } else { 
        alert('Completa todos los campos requeridos.'); 
      }
    } catch (error) {
      alert('Error al registrarse como vendedor');
    }
  });

  // Logout
  btnLogout?.addEventListener('click', async () => {
    console.log('Logout clicked');
    try {
      const response = await fetch('/api/auth/logout', { method: 'POST' }); 
      console.log('Logout response:', response.ok);
      
      // Forzar refreshMe inmediatamente y tambiÃ©n despuÃ©s de un delay
      refreshMe();
      setTimeout(() => {
        console.log('Refreshing after timeout');
        refreshMe(); 
      }, 200);
    } catch (error) {
      console.error('Error al cerrar sesiÃ³n:', error);
      // Forzar refreshMe incluso si hay error
      refreshMe();
    }
  });

  // Inicializar
  refreshMe();
</script>


  </div>
</BaseLayout>