---
import BaseLayout from '../layouts/BaseLayout.astro'
import SearchBarAI from '../components/react/SearchBarAI.tsx'
import QuickActions from '../components/react/QuickActions.tsx'
import DynamicGridBlocksSimple from '../components/react/DynamicGridBlocksSimple.tsx'
import HomeFeedV2 from '../components/feed/HomeFeedV2.tsx'
import MixedFeedSimple from '../components/react/MixedFeedSimple.tsx'
import AuthWrapper from '../components/react/AuthWrapper.tsx'
import QuestionModal from '../components/react/QuestionModal.tsx'
import SaleModal from '../components/react/SaleModal.tsx'
---

<BaseLayout 
  title="Town - Feed Social de Compras"
  description="Descubre productos locales en un feed tipo red social - Town"
>
  <link rel="stylesheet" href="/src/styles/feed-animations.css" />
  <div class="min-h-screen bg-primary">

    <!-- Banner Promocional -->
    <section class="px-4 py-6">
      <div class="max-w-7xl mx-auto">
        <div class="relative aspect-[16/9] rounded-2xl overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-r from-accent/20 to-accent/10 flex items-center justify-center">
            <div class="text-center text-white">
              <h2 class="text-3xl font-bold mb-2">춰ENV칈O GRATIS</h2>
              <p class="text-lg opacity-90">En compras superiores a $10.000</p>
      </div>
          </div>
          <!-- Imagen de fondo opcional -->
          <div class="absolute inset-0 bg-gradient-to-br from-primary via-muted to-surface opacity-50"></div>
      </div>
    </div>
  </section>

    <!-- Search Bar con IA -->
    <section class="px-4 pb-6">
      <div class="max-w-7xl mx-auto">
        <SearchBarAI 
          client:load 
          onSubmit={async (query) => {
            console.log('游댌 B칰squeda IA:', query);
            // La b칰squeda se maneja internamente en SearchBarAI
          }}
        />
    </div>
  </section>

    <!-- Acciones R치pidas -->
    <QuickActions 
      client:load 
      onAskQuestion={() => {
        document.getElementById('question-modal')?.click();
      }}
      onPublishSale={() => {
        document.getElementById('sale-modal')?.click();
      }}
    />

    <!-- Grid Din치mico de 4 Bloques -->
    <DynamicGridBlocksSimple 
      client:load 
      onAddToCart={(productId) => {
        console.log('Add to cart:', productId);
        // TODO: Implementar a침adir al carrito
      }}
      onViewProduct={(productId) => {
        console.log('View product:', productId);
        // TODO: Implementar ver producto
      }}
      onContactService={(serviceId) => {
        console.log('Contact service:', serviceId);
        // TODO: Implementar contacto con servicio
      }}
    />

    <!-- Feed Principal V2 - Mezclado -->
    <main class="pb-20">
      <AuthWrapper 
        client:load 
        className=""
      />
    </main>

    <!-- Modales -->
    <QuestionModal 
      client:load 
      isOpen={false}
      onClose={() => {}}
      onSubmit={(question) => {
        console.log('Question submitted:', question);
        // TODO: Implementar env칤o de pregunta
      }}
    />

    <SaleModal 
      client:load 
      isOpen={false}
      onClose={() => {}}
      onSubmit={(sale) => {
        console.log('Sale submitted:', sale);
        // TODO: Implementar env칤o de venta
      }}
    />


  </div>
</BaseLayout>

<script>
  // L칩gica para abrir modales y manejar carrito
  document.addEventListener('DOMContentLoaded', () => {
    console.log('Feed Social de Compras cargado');
    
    // Inicializar carrito vac칤o si no existe
    if (!localStorage.getItem('cart')) {
      localStorage.setItem('cart', '[]');
    }
    
    // Escuchar eventos de actualizaci칩n del carrito
    window.addEventListener('cart-updated', (event) => {
      console.log('游 Carrito actualizado:', event.detail);
      
      // Actualizar contador en el header
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
      
      // Buscar y actualizar contador en el header
      const cartCountElements = document.querySelectorAll('[data-cart-count], .cart-count, .cart-badge');
      cartCountElements.forEach(element => {
        element.textContent = totalItems.toString();
        element.style.display = totalItems > 0 ? 'block' : 'none';
      });
      
      console.log(`游늵 Carrito actual: ${totalItems} items total`);
      console.log('游 Items en carrito:', cart);
    });
  });
</script>