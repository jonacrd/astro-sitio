---
import BaseLayout from '../layouts/BaseLayout.astro'
import SellerGuard from '../components/react/SellerGuard.tsx'
import SellerStatusToggle from '../components/react/SellerStatusToggle.tsx'
import SellerProductManager from '../components/react/SellerProductManager.tsx'
import OrderHistory from '../components/react/OrderHistory.tsx'
import SellerRewardsInfo from '../components/react/SellerRewardsInfo.tsx'
---

<BaseLayout title="Dashboard Vendedor">
  <SellerGuard client:load>
    <main class="min-h-screen bg-gray-50">
      <div class="container mx-auto px-4 py-8">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">Dashboard Vendedor</h1>
          <p class="text-gray-600">Gestiona tu inventario y ventas</p>
        </div>

        <!-- Acciones r치pidas -->
        <div class="mb-8">
          <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Acciones R치pidas</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <a 
                href="/dashboard/recompensas" 
                class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors text-center"
              >
                游꾸 Sistema de Recompensas
              </a>
              <a 
                href="/dashboard/productos" 
                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors text-center"
              >
                游닍 Gestionar Productos
              </a>
              <a 
                href="/dashboard/pedidos" 
                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors text-center"
              >
                游늶 Ver Pedidos
              </a>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Estado Online -->
          <div class="lg:col-span-1">
            <SellerStatusToggle client:load />
          </div>

          <!-- Inventario -->
          <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md p-6">
              <h2 class="text-xl font-semibold text-gray-800 mb-4">Mi Inventario</h2>
              <SellerProductManager client:load />
            </div>
          </div>
        </div>

        <!-- Informaci칩n del sistema de recompensas -->
        <div class="mt-8">
          <SellerRewardsInfo client:load />
        </div>

        <!-- Historial de ventas -->
        <div class="mt-8">
          <OrderHistory client:load userType="seller" />
        </div>

        <!-- Estad칤sticas -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Ventas Hoy</h3>
            <p class="text-3xl font-bold text-green-600">$0</p>
          </div>
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Productos Activos</h3>
            <p class="text-3xl font-bold text-blue-600">0</p>
          </div>
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Stock Bajo</h3>
            <p class="text-3xl font-bold text-red-600">0</p>
          </div>
        </div>
      </div>
    </main>
  </SellerGuard>
</BaseLayout>

<script>
  // Cargar inventario del vendedor
  async function loadInventory() {
    try {
      const { supabase } = await import('../lib/supabase-browser');
      
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data: inventory, error } = await supabase
        .from('seller_products')
        .select(`
          id,
          stock,
          active,
          price_cents,
          product:products(
            id,
            title,
            category,
            image_url
          )
        `)
        .eq('seller_id', user.id);

      if (error) {
        console.error('Error loading inventory:', error);
        return;
      }

      const container = document.getElementById('inventory-container');
      if (!container) return;

      if (!inventory || inventory.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <p class="text-gray-500 mb-4">No tienes productos en tu inventario</p>
            <button onclick="addProducts()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
              Agregar Productos
            </button>
          </div>
        `;
        return;
      }

      container.innerHTML = inventory.map((item: any) => `
        <div class="border border-gray-200 rounded-lg p-4 mb-4">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-semibold text-gray-800">${item.product?.title || 'Producto'}</h4>
              <p class="text-sm text-gray-600">Categor칤a: ${item.product?.category || 'N/A'}</p>
              <p class="text-sm text-gray-600">Precio: $${(item.price_cents / 100).toFixed(2)}</p>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-600">Stock: <span class="font-semibold ${item.stock < 5 ? 'text-red-600' : 'text-green-600'}">${item.stock}</span></p>
              <p class="text-sm text-gray-600">Estado: <span class="font-semibold ${item.active ? 'text-green-600' : 'text-red-600'}">${item.active ? 'Activo' : 'Inactivo'}</span></p>
            </div>
          </div>
        </div>
      `).join('');
    } catch (error) {
      console.error('Error loading inventory:', error);
    }
  }

  // Funci칩n para agregar productos (placeholder)
  (window as any).addProducts = function() {
    alert('Funci칩n de agregar productos en desarrollo');
  };

  // Cargar inventario al cargar la p치gina
  document.addEventListener('DOMContentLoaded', loadInventory);
</script>
