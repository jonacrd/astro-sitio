---
// Carrusel de secciones de moda (Hombre, Mujer, Niños, Zapatos, Accesorios)
import { prisma } from '../lib/db';

// Obtener productos por categorías usando filtros en el nombre o descripción
const categoryData = await Promise.all([
  prisma.product.findMany({
    where: { 
      OR: [
        { name: { contains: 'hombre' } },
        { description: { contains: 'hombre' } }
      ]
    },
    take: 4
  }),
  prisma.product.findMany({
    where: { 
      OR: [
        { name: { contains: 'mujer' } },
        { description: { contains: 'mujer' } }
      ]
    },
    take: 4
  }),
  prisma.product.findMany({
    where: { 
      OR: [
        { name: { contains: 'niño' } },
        { description: { contains: 'niño' } }
      ]
    },
    take: 4
  }),
  prisma.product.findMany({
    where: { 
      OR: [
        { name: { contains: 'zapato' } },
        { description: { contains: 'zapato' } }
      ]
    },
    take: 4
  }),
  prisma.product.findMany({
    where: { 
      OR: [
        { name: { contains: 'accesorio' } },
        { description: { contains: 'accesorio' } }
      ]
    },
    take: 4
  })
]);

const sections = [
  { 
    id: 'hombre', 
    name: 'HOMBRE', 
    products: categoryData[0], 
    color: '#2c3e50',
    gradient: 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)',
    icon: '👔'
  },
  { 
    id: 'mujer', 
    name: 'MUJER', 
    products: categoryData[1], 
    color: '#e74c3c',
    gradient: 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)',
    icon: '👗'
  },
  { 
    id: 'ninos', 
    name: 'NIÑOS', 
    products: categoryData[2], 
    color: '#f39c12',
    gradient: 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)',
    icon: '🧸'
  },
  { 
    id: 'zapatos', 
    name: 'ZAPATOS', 
    products: categoryData[3], 
    color: '#8e44ad',
    gradient: 'linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%)',
    icon: '👟'
  },
  { 
    id: 'accesorios', 
    name: 'ACCESORIOS', 
    products: categoryData[4], 
    color: '#27ae60',
    gradient: 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)',
    icon: '💍'
  }
];
---

<style>
  .category-carousel {
    min-width: 100dvw;
    padding: 80px 20px;
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 50%, #e9ecef 100%);
    overflow: hidden;
    position: relative;
    z-index: 10;

  }

  .category-carousel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%232c3e50" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="%232c3e50" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="%232c3e50" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="%232c3e50" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="%232c3e50" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.3;
    z-index: 1;
  }

  .carousel-header {
    height: 100px;
    text-align: center;
    margin-bottom: 30px;
    position: relative;
    z-index: 2;
  }

  .carousel-title {
    font-size: 3rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 15px;
    text-shadow: 3px 3px 6px rgba(0,0,0,0.2);
    background: linear-gradient(135deg, #2c3e50, #34495e);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .carousel-subtitle {
    font-size: 1.1rem;
    color: #6c757d;
    max-width: 500px;
    margin: 0 auto;
    line-height: 1.4;
    font-weight: 500;
  }

  .carousel-container {
    position: relative;
    max-width: 500px;
    margin: 0 auto;
    overflow: hidden;
    height: 400px;
    width: 100%;
    padding: 0 20px;
    margin-bottom: 60px;
  }

  .carousel-track {
    display: flex;
    transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    height: 100%;
  }

  .category-section {
    flex: 0 0 100%;
    background: white;
    border-radius: 25px;
    overflow: hidden;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
    margin: 0 5px;
    width: calc(100% - 10px);
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .category-section:hover {
    transform: translateY(-10px);
    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
  }

  .section-header {
    padding: 40px 30px;
    text-align: center;
    position: relative;
    overflow: hidden;
    height: 50px;
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
  }

  .section-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    opacity: 0.1;
    z-index: 1;
  }

  .section-icon {
    font-size: 2rem;
    margin-bottom: 25px;
    display: block;
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
    position: relative;
    z-index: 2;
  }

  .section-title {
    font-size: 1.2rem;
    font-weight: bold;
    color: white;
    margin-bottom: 20px;
    text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
    position: relative;
    z-index: 2;
    letter-spacing: 2px;
  }

  .section-subtitle {
    font-size: 1.3rem;
    color: rgba(255,255,255,0.95);
    margin-bottom: 30px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
    position: relative;
    z-index: 2;
    font-weight: 500;
  }

  .section-cta {
    background: rgba(255,255,255,0.25);
    color: white;
    border: 3px solid rgba(255,255,255,0.4);
    padding: 15px 30px;
    border-radius: 30px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(15px);
    position: relative;
    z-index: 2;
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .section-cta:hover {
    background: rgba(94, 94, 94, 0.35);
    border-color: rgba(255,255,255,0.6);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  }

  .section-products {
    padding: 30px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    background: rgba(73, 73, 73, 0.8);
    flex: 1;
    overflow-y: auto;
    height: calc(100% - 200px);
  }

  .product-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.05);
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  }

  .product-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    background: #e9ecef;
    transition: transform 0.3s ease;
  }

  .product-card:hover .product-image {
    transform: scale(1.05);
  }

  .product-info {
    padding: 15px;
    text-align: center;
  }

  .product-name {
    font-size: 0.9rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 8px;
    line-height: 1.3;
  }

  .product-price {
    font-size: 1.1rem;
    font-weight: bold;
    color: #e74c3c;
    margin-bottom: 10px;
  }

  .product-stock {
    font-size: 0.8rem;
    color: #27ae60;
    font-weight: 600;
    margin-bottom: 10px;
  }

  .product-stock.low { color: #f39c12; }
  .product-stock.out { color: #e74c3c; }

  .add-to-cart-btn {
    width: 100%;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 15px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.8rem;
  }

  .add-to-cart-btn:hover {
    background: linear-gradient(135deg, #2980b9, #1f618d);
    transform: translateY(-1px);
  }

  .add-to-cart-btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
    transform: none;
  }

  /* Colores específicos por sección */
  .category-section.hombre .section-header::before {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  }

  .category-section.mujer .section-header::before {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  }

  .category-section.ninos .section-header::before {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
  }

  .category-section.zapatos .section-header::before {
    background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
  }

  .category-section.accesorios .section-header::before {
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
  }

  /* Controles del carrusel */
  .carousel-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 40px;
    position: relative;
    z-index: 2;
  }

  .carousel-btn {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .carousel-btn:hover {
    background: linear-gradient(135deg, #34495e, #2c3e50);
    transform: scale(1.1);
  }

  .carousel-btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
    transform: none;
  }

  .carousel-indicators {
    display: flex;
    gap: 10px;
  }

  .indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #bdc3c7;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .indicator.active {
    background: #2c3e50;
    transform: scale(1.2);
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .carousel-container {
      height: 550px;
      padding: 0 15px;
    }
    
    .section-header {
      height: 180px;
      padding: 30px 25px;
    }
    
    .section-products {
      height: calc(100% - 180px);
      padding: 25px;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 18px;
    }
  }

  @media (max-width: 768px) {
    .carousel-container {
      height: 500px;
      padding: 0 10px;
    }
    
    .carousel-title {
      font-size: 2.5rem;
    }
    
    .section-title {
      font-size: 2rem;
    }
    
    .section-icon {
      font-size: 3.5rem;
    }
    
    .section-header {
      height: 160px;
      padding: 25px 20px;
    }
    
    .section-products {
      height: calc(100% - 160px);
      padding: 20px;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
    }
    
    .product-image {
      height: 100px;
    }
  }

  @media (max-width: 480px) {
    .carousel-container {
      height: 450px;
      padding: 0 5px;
    }
    
    .carousel-title {
      font-size: 2rem;
    }
    
    .section-title {
      font-size: 1.5rem;
    }
    
    .section-icon {
      font-size: 2.5rem;
    }
    
    .section-header {
      height: 140px;
      padding: 20px 15px;
    }
    
    .section-products {
      height: calc(100% - 140px);
      padding: 15px;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
    }
    
    .product-image {
      height: 80px;
    }
  }
</style>

<section class="category-carousel">
  <div class="carousel-header">
    <h2 class="carousel-title">🌟 MODA POR CATEGORÍAS</h2>
    <p class="carousel-subtitle">
      Descubre las mejores colecciones de moda para cada estilo
    </p>
  </div>

  <div class="carousel-container">
    <div class="carousel-track" id="category-carousel-track">
      {sections.map(section => (
        <div class={`category-section ${section.id}`}>
          <div class="section-header">
            <h3 class="section-title">{section.name}</h3>
            <p class="section-subtitle">Los mejores productos para {section.name.toLowerCase()}</p>
            <button class="section-cta" onclick={`goToCategory('${section.id}')`}>
              Ver Colección
            </button>
          </div>
          
          <div class="section-products">
            {section.products.map(product => {
              const totalStock = product.stock || 0;
              const price = (product.priceCents || 0) / 100;
              
              let stockStatus = 'in-stock';
              let stockText = `${totalStock} disponibles`;
              
              if (totalStock === 0) {
                stockStatus = 'out';
                stockText = 'Agotado';
              } else if (totalStock < 10) {
                stockStatus = 'low';
                stockText = `Solo ${totalStock}`;
              }

              return (
                <div class="product-card">
                  <img 
                    src={product.imageUrl || '/img/ropa-caballero.png'} 
                    alt={product.name}
                    class="product-image"
                  />
                  <div class="product-info">
                    <h4 class="product-name">{product.name}</h4>
                    <p class="product-price">${price.toFixed(2)}</p>
                    <p class={`product-stock ${stockStatus}`}>{stockText}</p>
                    <button 
                      class="add-to-cart-btn"
                      data-product-id={product.id}
                      data-product-name={product.name}
                      data-product-price={price}
                      data-product-image={product.imageUrl}
                      data-stock={totalStock}
                      disabled={totalStock === 0}
                      onclick={`addToCart(${product.id}, '${product.name}', ${price}, '${product.imageUrl || ''}', ${totalStock})`}
                    >
                      {totalStock === 0 ? 'Agotado' : 'Agregar'}
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  </div>

  <div class="carousel-controls">
    <button class="carousel-btn" id="category-prev">‹</button>
    <div class="carousel-indicators" id="category-indicators"></div>
    <button class="carousel-btn" id="category-next">›</button>
  </div>
</section>

<script>
  class CategoryCarousel {
    constructor() {
      this.currentIndex = 0;
      this.totalItems = document.querySelectorAll('.category-section').length;
      this.track = document.getElementById('category-carousel-track');
      this.prevBtn = document.getElementById('category-prev');
      this.nextBtn = document.getElementById('category-next');
      this.indicators = document.getElementById('category-indicators');
      
      this.init();
    }

    init() {
      this.createIndicators();
      this.bindEvents();
      this.updateCarousel();
      this.startAutoPlay();
    }

    createIndicators() {
      for (let i = 0; i < this.totalItems; i++) {
        const indicator = document.createElement('div');
        indicator.className = `indicator ${i === 0 ? 'active' : ''}`;
        indicator.addEventListener('click', () => this.goToSlide(i));
        this.indicators.appendChild(indicator);
      }
    }

    bindEvents() {
      this.prevBtn.addEventListener('click', () => this.prevSlide());
      this.nextBtn.addEventListener('click', () => this.nextSlide());
      
      // Pausar autoplay al hacer hover
      this.track.addEventListener('mouseenter', () => this.stopAutoPlay());
      this.track.addEventListener('mouseleave', () => this.startAutoPlay());
    }

    updateCarousel() {
      const translateX = -this.currentIndex * 100; // 100% por sección
      this.track.style.transform = `translateX(${translateX}%)`;
      
      // Actualizar indicadores
      const indicators = this.indicators.querySelectorAll('.indicator');
      indicators.forEach((indicator, index) => {
        indicator.classList.toggle('active', index === this.currentIndex);
      });
      
      // Actualizar botones
      this.prevBtn.disabled = this.currentIndex === 0;
      this.nextBtn.disabled = this.currentIndex >= this.totalItems - 1;
    }

    nextSlide() {
      if (this.currentIndex < this.totalItems - 1) {
        this.currentIndex++;
        this.updateCarousel();
      } else {
        // Volver al inicio para crear el efecto infinito
        this.currentIndex = 0;
        this.updateCarousel();
      }
    }

    prevSlide() {
      if (this.currentIndex > 0) {
        this.currentIndex--;
        this.updateCarousel();
      } else {
        // Ir al final para crear el efecto infinito
        this.currentIndex = this.totalItems - 1;
        this.updateCarousel();
      }
    }

    goToSlide(index) {
      this.currentIndex = index;
      this.updateCarousel();
    }

    startAutoPlay() {
      this.autoPlayInterval = setInterval(() => {
        this.nextSlide();
      }, 4000); // Cambiar cada 4 segundos
    }

    stopAutoPlay() {
      if (this.autoPlayInterval) {
        clearInterval(this.autoPlayInterval);
      }
    }
  }

  // Funciones globales
  function goToCategory(categoryId) {
    window.location.href = `/catalogo?categoria=${categoryId}`;
  }

  // Inicializar cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', () => {
    new CategoryCarousel();
    window.goToCategory = goToCategory;
  });
</script>
