---
// Carrusel de secciones destacadas como en Vstore.cl
import { prisma } from '../lib/db';

// Obtener productos por categor√≠as para las secciones destacadas
const categorySections = await Promise.all([
  prisma.product.findMany({
    where: { category: { name: { contains: 'hombre' } } },
    include: {
      variants: {
        include: { inventory: true }
      },
      category: true
    },
    take: 6
  }),
  prisma.product.findMany({
    where: { category: { name: { contains: 'mujer' } } },
    include: {
      variants: {
        include: { inventory: true }
      },
      category: true
    },
    take: 6
  }),
  prisma.product.findMany({
    where: { category: { name: { contains: 'ni√±o' } } },
    include: {
      variants: {
        include: { inventory: true }
      },
      category: true
    },
    take: 6
  }),
  prisma.product.findMany({
    where: { category: { name: { contains: 'zapatos' } } },
    include: {
      variants: {
        include: { inventory: true }
      },
      category: true
    },
    take: 6
  }),
  prisma.product.findMany({
    where: { category: { name: { contains: 'accesorio' } } },
    include: {
      variants: {
        include: { inventory: true }
      },
      category: true
    },
    take: 6
  })
]);

const sections = [
  { id: 'hombre', name: 'Hombre', products: categorySections[0], color: '#2c3e50' },
  { id: 'mujer', name: 'Mujer', products: categorySections[1], color: '#e74c3c' },
  { id: 'ninos', name: 'Ni√±os', products: categorySections[2], color: '#f39c12' },
  { id: 'zapatos', name: 'Zapatos', products: categorySections[3], color: '#8e44ad' },
  { id: 'accesorios', name: 'Accesorios', products: categorySections[4], color: '#27ae60' }
];
---

<style>
  .sections-carousel {
    padding: 60px 20px;
    background: white;
  }

  .sections-header {
    text-align: center;
    margin-bottom: 50px;
  }

  .sections-title {
    font-size: 3rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 20px;
  }

  .sections-subtitle {
    font-size: 1.2rem;
    color: #6c757d;
    max-width: 600px;
    margin: 0 auto;
  }

  .sections-container {
    max-width: 100%;
    margin: 0 auto;
    width: 100%;
    padding: 0 20px;
  }

  .section-tabs {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 40px;
    flex-wrap: wrap;
  }

  .section-tab {
    background: #f8f9fa;
    color: #6c757d;
    border: none;
    padding: 15px 30px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .section-tab.active {
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }

  .section-tab.hombre.active { background: #2c3e50; }
  .section-tab.mujer.active { background: #e74c3c; }
  .section-tab.ninos.active { background: #f39c12; }
  .section-tab.zapatos.active { background: #8e44ad; }
  .section-tab.accesorios.active { background: #27ae60; }

  .section-content {
    position: relative;
    overflow: hidden;
  }

  .section-products {
    display: flex;
    gap: 30px;
    transition: transform 0.5s ease-in-out;
  }

  .section-product {
    flex: 0 0 260px;
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    min-height: 320px;
  }

  .section-product:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
  }

  .product-image {
    width: 100%;
    height: 180px;
    object-fit: cover;
  }

  .product-details {
    padding: 20px;
  }

  .product-name {
    font-size: 1rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 8px;
    line-height: 1.3;
  }

  .product-price {
    font-size: 1.2rem;
    font-weight: bold;
    color: #e74c3c;
    margin-bottom: 15px;
  }

  .product-stock {
    font-size: 0.8rem;
    color: #27ae60;
    margin-bottom: 15px;
    font-weight: 600;
  }

  .product-stock.low { color: #f39c12; }
  .product-stock.out { color: #e74c3c; }

  .add-to-cart-btn {
    width: 100%;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 15px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.8rem;
  }

  .add-to-cart-btn:hover {
    background: linear-gradient(135deg, #2980b9, #1f618d);
    transform: translateY(-1px);
  }

  .add-to-cart-btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
    transform: none;
  }

  .section-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 30px;
  }

  .section-btn {
    background: #f8f9fa;
    color: #6c757d;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .section-btn:hover {
    background: #e9ecef;
    color: #2c3e50;
  }

  .section-btn:disabled {
    background: #f8f9fa;
    color: #bdc3c7;
    cursor: not-allowed;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .sections-container {
      padding: 0 15px;
    }
    
    .section-product {
      flex: 0 0 240px;
    }
    
    .product-image {
      height: 160px;
    }
  }

  @media (max-width: 768px) {
    .sections-container {
      padding: 0 10px;
    }
    
    .section-tabs {
      gap: 10px;
    }
    
    .section-tab {
      padding: 10px 20px;
      font-size: 0.9rem;
    }
    
    .section-product {
      flex: 0 0 220px;
      min-height: 300px;
    }
    
    .product-image {
      height: 140px;
    }
  }

  @media (max-width: 480px) {
    .sections-container {
      padding: 0 5px;
    }
    
    .section-product {
      flex: 0 0 200px;
      min-height: 280px;
    }
    
    .product-image {
      height: 120px;
    }
  }
</style>

<section class="sections-carousel">
  <div class="sections-header">
    <h2 class="sections-title">üåü LO DESTACADO POR CATEGOR√çA</h2>
    <p class="sections-subtitle">
      Descubre los mejores productos de cada secci√≥n
    </p>
  </div>

  <div class="sections-container">
    <div class="section-tabs">
      {sections.map((section, index) => (
        <button 
          class={`section-tab ${section.id} ${index === 0 ? 'active' : ''}`}
          data-section={section.id}
          onclick={`showSection('${section.id}')`}
        >
          {section.name}
        </button>
      ))}
    </div>

    <div class="section-content">
      {sections.map((section, sectionIndex) => (
        <div 
          class="section-products" 
          id={`section-${section.id}`}
          style={`display: ${sectionIndex === 0 ? 'flex' : 'none'}`}
        >
          {section.products.map(product => {
            const totalStock = product.variants.reduce((sum, variant) => {
              if (variant.inventory && Array.isArray(variant.inventory)) {
                return sum + variant.inventory.reduce((invSum, inv) => invSum + (inv.quantity || 0), 0);
              }
              return sum;
            }, 0);
            
            const prices = product.variants.map(v => v.salePriceCents || 0).filter(p => p > 0);
            const minPrice = prices.length > 0 ? Math.min(...prices) / 100 : 0;
            
            let stockStatus = 'in-stock';
            let stockText = `${totalStock} disponibles`;
            
            if (totalStock === 0) {
              stockStatus = 'out';
              stockText = 'Agotado';
            } else if (totalStock < 10) {
              stockStatus = 'low';
              stockText = `Solo ${totalStock}`;
            }

            return (
              <div class="section-product">
                <img 
                  src={product.imageUrl || '/img/ropa-caballero.png'} 
                  alt={product.name}
                  class="product-image"
                />
                <div class="product-details">
                  <h3 class="product-name">{product.name}</h3>
                  <p class="product-price">${minPrice.toFixed(2)}</p>
                  <p class={`product-stock ${stockStatus}`}>{stockText}</p>
                  <button 
                    class="add-to-cart-btn"
                    data-product-id={product.id}
                    data-product-name={product.name}
                    data-product-price={minPrice}
                    data-product-image={product.imageUrl}
                    data-stock={totalStock}
                    disabled={totalStock === 0}
                    onclick={`addToCart(${product.id}, '${product.name}', ${minPrice}, '${product.imageUrl || ''}', ${totalStock})`}
                  >
                    {totalStock === 0 ? 'Agotado' : 'Agregar'}
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      ))}
    </div>

    <div class="section-controls">
      <button class="section-btn" id="section-prev">‚Äπ</button>
      <button class="section-btn" id="section-next">‚Ä∫</button>
    </div>
  </div>
</section>

<script>
  class SectionCarousel {
    constructor() {
      this.currentSection = 0;
      this.sections = ['hombre', 'mujer', 'ninos', 'zapatos', 'accesorios'];
      this.currentProductIndex = 0;
      this.productsPerView = 4;
      
      this.init();
    }

    init() {
      this.bindEvents();
      this.updateSection();
    }

    bindEvents() {
      // Botones de secci√≥n
      document.querySelectorAll('.section-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const sectionId = e.target.dataset.section;
          this.showSection(sectionId);
        });
      });

      // Botones de navegaci√≥n
      document.getElementById('section-prev').addEventListener('click', () => this.prevProducts());
      document.getElementById('section-next').addEventListener('click', () => this.nextProducts());
    }

    showSection(sectionId) {
      // Actualizar tabs
      document.querySelectorAll('.section-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');

      // Mostrar productos de la secci√≥n
      document.querySelectorAll('.section-products').forEach(section => {
        section.style.display = 'none';
      });
      document.getElementById(`section-${sectionId}`).style.display = 'flex';

      this.currentSection = this.sections.indexOf(sectionId);
      this.currentProductIndex = 0;
      this.updateSection();
    }

    updateSection() {
      const currentSectionElement = document.querySelector('.section-products[style*="flex"]');
      if (currentSectionElement) {
        const totalProducts = currentSectionElement.children.length;
        const maxIndex = Math.max(0, totalProducts - this.productsPerView);
        
        const translateX = -this.currentProductIndex * (250 + 30); // 250px product + 30px gap
        currentSectionElement.style.transform = `translateX(${translateX}px)`;
        
        // Actualizar botones
        document.getElementById('section-prev').disabled = this.currentProductIndex === 0;
        document.getElementById('section-next').disabled = this.currentProductIndex >= maxIndex;
      }
    }

    prevProducts() {
      if (this.currentProductIndex > 0) {
        this.currentProductIndex--;
        this.updateSection();
      }
    }

    nextProducts() {
      const currentSectionElement = document.querySelector('.section-products[style*="flex"]');
      if (currentSectionElement) {
        const totalProducts = currentSectionElement.children.length;
        const maxIndex = Math.max(0, totalProducts - this.productsPerView);
        
        if (this.currentProductIndex < maxIndex) {
          this.currentProductIndex++;
          this.updateSection();
        }
      }
    }
  }

  // Funciones globales
  function showSection(sectionId) {
    window.sectionCarousel.showSection(sectionId);
  }

  // Inicializar cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', () => {
    window.sectionCarousel = new SectionCarousel();
    window.showSection = showSection;
  });
</script>
